# Example Caddyfile for InvenTree
# The following environment variables may be used:
# - INVENTREE_SITE_URL: The upstream URL of the InvenTree site (default: inventree.localhost)
# - INVENTREE_SERVER: The internal URL of the InvenTree container (default: http://inventree-server:8000)
#
# Note that while this file is a good starting point, it may need to be modified to suit your specific requirements
#
# Ref to the Caddyfile documentation: https://caddyserver.com/docs/caddyfile

{
	admin off
}

# Logging configuration for Caddy
(log_common) {
	log {
		output stderr
		level info
	}
}

# CORS headers control (used for static and media files)
(cors) {
	@cors_preflight{args.0} method OPTIONS
	@cors{args.0} header Origin {args.0}

	handle @cors_preflight{args.0} {
		header {
			Allow GET,HEAD,OPTIONS
			Access-Control-Allow-Origin "{args.0}"
			Access-Control-Allow-Methods GET,HEAD,OPTIONS
			Access-Control-Allow-Headers Authorization,Content-Type,User-Agent
			defer
		}
		respond "" 204
	}

	handle @cors{args.0} {
		header {
			Access-Control-Allow-Origin "{args.0}"
			Access-Control-Expose-Headers Authorization,Content-Type,User-Agent
			defer
		}
	}
}

# The default server address is configured in the .env file
# If not specified, the default address is used - http://inventree.localhost
# If you need to listen on multiple addresses, or use a different port, you can modify this section directly
{$INVENTREE_SITE_URL:http://inventree.localhost} {
	import log_common inventree

	encode gzip

	request_body {
		max_size 100MB
	}

	# Handle static request files
	handle_path /assets/* {
		import cors {header.origin}

		root * {$INVENTREE_STATIC_ROOT}/web/assets
		file_server
	}

	# Handle static request files
	handle_path /static/* {
		import cors {header.origin}

		root * {$INVENTREE_STATIC_ROOT}
		file_server
	}

	# All other requests are proxied to the InvenTree server
	reverse_proxy {$INVENTREE_SERVER:"http://inventree-server:8000"} {
		transport http {
			dial_timeout 10s
			dial_fallback_delay -1s
		}

		# If you are running behind another proxy, you may need to specify 'trusted_proxies'
		# Ref: https://caddyserver.com/docs/json/apps/http/servers/trusted_proxies/
		# trusted_proxies ...
	}
}
